<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>نظام فواتير - تسجيل دخول</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
<style>
:root { --primary-color: #2b7a78; --secondary-color: #3aa6a4; --background-color: #f6f8f8; --text-color: #333; --card-bg: #fff; }
body { font-family: 'Cairo', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; direction: rtl; }
.container { max-width: 1200px; margin: auto; }
.card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 20px;}
h2 { text-align: center; margin-bottom: 20px;}
input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
button { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;}
button:hover { background: #20615f; }
.hidden { display: none; }
.logout-btn { float:left; background:#e53935; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;}
</style>
</head>
<body>
<div class="container">
    <!-- شاشة تسجيل الدخول -->
    <div class="card" id="loginSection">
        <h2>تسجيل الدخول</h2>
        <input type="text" id="username" placeholder="اسم المستخدم" />
        <input type="password" id="password" placeholder="كلمة المرور" />
        <button onclick="localLogin()">دخول</button>
    </div>

    <!-- محتوى التطبيق -->
    <div id="appContent" class="hidden">
        <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
        <h2>نظام الفواتير</h2>
        <!-- هنا سنضع نموذج الفواتير -->
        <div class="card">
            <form id="invoiceForm">
                <div class="form-grid">
                    <input type="text" id="invoiceNo" placeholder="رقم الفاتورة" required />
                    <input type="date" id="date" required />
                    <input type="text" id="name" placeholder="اسم العميل" required />
                    <input type="text" id="region" placeholder="المنطقة" required />
                    <input type="number" id="count" placeholder="العدد" oninput="calculateTotal()" />
                    <input type="number" id="weight" placeholder="الوزن" oninput="calculateTotal()" />
                    <input type="text" id="type" placeholder="النوع" />
                    <input type="number" id="price" placeholder="السعر" oninput="calculateTotal()" />
                    <input type="number" id="total" placeholder="الإجمالي" readonly />
                    <input type="number" id="paid" placeholder="المدفوع" oninput="updateRemaining()" />
                    <input type="number" id="remaining" placeholder="المتبقي" readonly />
                    <input type="text" id="note" placeholder="ملاحظات" />
                </div>
                <button type="button" onclick="addInvoice()">إضافة فاتورة</button>
            </form>
        </div>
        <div class="card">
            <table id="invoiceTable" border="1" width="100%">
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th><th>التاريخ</th><th>الاسم</th><th>المنطقة</th>
                        <th>العدد</th><th>الوزن</th><th>النوع</th><th>السعر</th>
                        <th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>ملاحظات</th><th>إجراءات</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
/* ===== إعداد Firebase ===== */
const firebaseConfig = {
    apiKey: "AIzaSyAyJUFnNx0GA_kr1K4RJv0QjXrSj6hPEzw",
    authDomain: "bill-52bc1.firebaseapp.com",
    projectId: "bill-52bc1",
    storageBucket: "bill-52bc1.firebasestorage.app",
    messagingSenderId: "674828701661",
    appId: "1:674828701661:web:43027ab784b7510a227034"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== تسجيل الدخول المحلي ===== */
const validUsers = [
    { username: "admin", password: "admin", token: "admin-token" }
];

function localLogin() {
    const u = document.getElementById("username").value;
    const p = document.getElementById("password").value;
    const user = validUsers.find(x => x.username === u && x.password === p);
    if (user) {
        localStorage.setItem("authToken", user.token);
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appContent").classList.remove("hidden");
        fetchInvoices();
    } else {
        alert("اسم المستخدم أو كلمة المرور غير صحيحة");
    }
}

/* ===== تسجيل الخروج ===== */
function logout() {
    localStorage.removeItem("authToken");
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appContent").classList.add("hidden");
}

/* ===== التحقق عند تحميل الصفحة ===== */
window.onload = () => {
    if (localStorage.getItem("authToken")) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appContent").classList.remove("hidden");
        fetchInvoices();
    }
};

/* ===== إدارة الفواتير مع Firestore ===== */
let invoices = [];

async function fetchInvoices() {
    const snapshot = await db.collection("invoices").get();
    invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderTable();
}

function calculateTotal() {
    const count = parseFloat(countInput.value) || 0;
    const weight = parseFloat(weightInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    totalInput.value = (count > 0 ? count * price : weight * price);
    updateRemaining();
}

function updateRemaining() {
    remainingInput.value = (parseFloat(totalInput.value) || 0) - (parseFloat(paidInput.value) || 0);
}

async function addInvoice() {
    const inv = {
        invoiceNo: invoiceNo.value, date: date.value, name: name.value.trim(),
        region: region.value.trim(), count: countInput.value, weight: weightInput.value,
        type: type.value, price: priceInput.value, total: totalInput.value,
        paid: paidInput.value, remaining: remainingInput.value, note: note.value.trim()
    };
    if (!inv.invoiceNo || !inv.date || !inv.name) { alert("يرجى إدخال البيانات المطلوبة"); return; }
    await db.collection("invoices").add(inv);
    fetchInvoices();
}

function renderTable() {
    const tbody = document.querySelector("#invoiceTable tbody");
    tbody.innerHTML = "";
    invoices.forEach(inv => {
        tbody.innerHTML += `
            <tr>
                <td>${inv.invoiceNo}</td><td>${inv.date}</td><td>${inv.name}</td><td>${inv.region}</td>
                <td>${inv.count}</td><td>${inv.weight}</td><td>${inv.type}</td><td>${inv.price}</td>
                <td>${inv.total}</td><td>${inv.paid}</td><td>${inv.remaining}</td><td>${inv.note}</td>
                <td><button onclick="deleteInvoice('${inv.id}')">حذف</button></td>
            </tr>`;
    });
}

async function deleteInvoice(id) {
    if (confirm("هل أنت متأكد من الحذف؟")) {
        await db.collection("invoices").doc(id).delete();
        fetchInvoices();
    }
}

/* تسهيل الوصول لعناصر النموذج */
const invoiceNo = document.getElementById("invoiceNo");
const date = document.getElementById("date");
const name = document.getElementById("name");
const region = document.getElementById("region");
const countInput = document.getElementById("count");
const weightInput = document.getElementById("weight");
const type = document.getElementById("type");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");
const paidInput = document.getElementById("paid");
const remainingInput = document.getElementById("remaining");
const note = document.getElementById("note");
</script>
</body>
</html>