<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>نظام فواتير شركة عمار العزات وأولاده</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
<style>
/* ====== التصميم ====== */
:root {
    --primary-color: #2b7a78;
    --secondary-color: #3aa6a4;
    --accent-color: #8ed3cf;
    --background-color: #f6f8f8;
    --text-color: #333;
    --card-bg: #fff;
    --border-color: #e0e0e0;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
body { font-family: 'Cairo', sans-serif; background-color: var(--background-color); margin: 0; padding: 20px; direction: rtl; color: var(--text-color);}
.container { max-width: 1300px; margin: 0 auto; display: flex; flex-direction: column; gap: 25px;}
.header { text-align: center; background-color: var(--primary-color); color: #fff; padding: 25px; border-radius: 12px; box-shadow: var(--shadow);}
.header h1 { margin: 0; font-size: 2.2rem; font-weight: 700;}
.card { background-color: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: var(--shadow);}
button.google-btn {
    background-color: #db4437; color: #fff; border: none; padding: 12px 20px;
    border-radius: 8px; font-size: 1rem; cursor: pointer; margin-bottom: 20px;
}
.hidden { display: none; }
/* باقي التنسيقات كما في النسخ السابقة */
</style>
</head>
<body>
<div class="container">
    <div class="header"><h1>نظام فواتير شركة عمار العزات وأولاده</h1></div>

    <!-- زر تسجيل الدخول -->
    <div id="loginSection" class="card">
        <h2>تسجيل الدخول</h2>
        <button class="google-btn" onclick="loginWithGoogle()"><i class="fab fa-google"></i> تسجيل الدخول بحساب Google</button>
    </div>

    <!-- محتوى النظام -->
    <div id="appContent" class="hidden">
        <button onclick="logout()" style="float:left; background:#e53935; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;">تسجيل الخروج</button>
        <div class="card">
            <form id="invoiceForm">
                <div class="form-grid">
                    <div class="form-group"><label>رقم الفاتورة</label><input type="text" id="invoiceNo" required /></div>
                    <div class="form-group"><label>بالتاريخ</label><input type="date" id="date" required /></div>
                    <div class="form-group"><label>المطلوب من السيد</label><input type="text" id="name" required /></div>
                    <div class="form-group"><label>المقيم في</label><input type="text" id="region" required /></div>
                    <div class="form-group"><label>العدد</label><input type="number" id="count" oninput="calculateTotal()" /></div>
                    <div class="form-group"><label>الوزن (كغ)</label><input type="number" id="weight" oninput="calculateTotal()" /></div>
                    <div class="form-group"><label>النوع</label><input type="text" id="type" /></div>
                    <div class="form-group"><label>السعر</label><input type="number" id="price" oninput="calculateTotal()" /></div>
                    <div class="form-group"><label>المبلغ الإجمالي</label><input type="number" id="total" readonly /></div>
                    <div class="form-group"><label>المبلغ المدفوع</label><input type="number" id="paid" oninput="updateRemaining()" /></div>
                    <div class="form-group"><label>المتبقي</label><input type="number" id="remaining" readonly /></div>
                    <div class="form-group full-width"><label>ملاحظات</label><input type="text" id="note" /></div>
                </div>
                <div class="button-container"><button type="button" id="addBtn" onclick="addInvoice()" class="main-btn"><i class="fas fa-plus"></i> إضافة فاتورة</button></div>
            </form>
        </div>
        <div class="card">
            <div class="search-container">
                <input type="text" id="search" placeholder="ابحث برقم الفاتورة، الاسم، أو المنطقة..." oninput="searchInvoice()" />
                <button class="main-btn"><i class="fas fa-search"></i> بحث</button>
            </div>
        </div>
        <div class="card">
            <div class="table-container">
                <table id="invoiceTable">
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th><th>التاريخ</th><th>المطلوب من السيد</th><th>المقيم في</th>
                            <th>العدد</th><th>الوزن</th><th>النوع</th><th>السعر</th>
                            <th>الإجمالي</th><th>المدفوع</th><th>المتبقي</th><th>ملاحظات</th><th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="text-align: left; margin-top: 20px;">
                <button id="exportBtn" onclick="exportToExcel()" class="main-btn"><i class="fas fa-file-excel"></i> تصدير إلى Excel</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== Firebase Config =====
    const firebaseConfig = {
        apiKey: "AIzaSyAyJUFnNx0GA_kr1K4RJv0QjXrSj6hPEzw",
        authDomain: "bill-52bc1.firebaseapp.com",
        projectId: "bill-52bc1",
        storageBucket: "bill-52bc1.firebasestorage.app",
        messagingSenderId: "674828701661",
        appId: "1:674828701661:web:43027ab784b7510a227034"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let invoices = [];
    let editId = null;

    // ===== تسجيل الدخول بحساب جوجل =====
    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).then(() => {
            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("appContent").classList.remove("hidden");
            fetchInvoices();
        }).catch(err => alert("خطأ في تسجيل الدخول: " + err.message));
    }

    // ===== تسجيل الخروج =====
    function logout() {
        auth.signOut().then(() => {
            document.getElementById("loginSection").classList.remove("hidden");
            document.getElementById("appContent").classList.add("hidden");
        });
    }

    // ===== جلب الفواتير =====
    async function fetchInvoices() {
        const snapshot = await db.collection("invoices").get();
        invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTable();
    }

    function calculateTotal() {
        const count = parseFloat(count.value) || 0;
        const weight = parseFloat(weight.value) || 0;
        const price = parseFloat(price.value) || 0;
        total.value = (count > 0 ? count * price : weight * price);
        updateRemaining();
    }

    function updateRemaining() {
        remaining.value = (parseFloat(total.value) || 0) - (parseFloat(paid.value) || 0);
    }

    async function addInvoice() {
        const inv = {
            invoiceNo: invoiceNo.value, date: date.value, name: name.value.trim(),
            region: region.value.trim(), count: count.value, weight: weight.value,
            type: type.value, price: price.value, total: total.value,
            paid: paid.value, remaining: remaining.value, note: note.value.trim()
        };
        if (!inv.invoiceNo || !inv.date || !inv.name) { alert("يرجى إدخال البيانات المطلوبة"); return; }
        if (editId) { await db.collection("invoices").doc(editId).set(inv); editId = null; }
        else { await db.collection("invoices").add(inv); }
        invoiceForm.reset();
        fetchInvoices();
    }

    function renderTable() {
        const tbody = document.querySelector("#invoiceTable tbody");
        tbody.innerHTML = "";
        invoices.forEach(inv => {
            tbody.innerHTML += `
                <tr>
                    <td>${inv.invoiceNo}</td><td>${inv.date}</td><td>${inv.name}</td><td>${inv.region}</td>
                    <td>${inv.count}</td><td>${inv.weight}</td><td>${inv.type}</td><td>${inv.price}</td>
                    <td>${inv.total}</td><td>${inv.paid}</td><td>${inv.remaining}</td><td>${inv.note}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editInvoice('${inv.id}')"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteInvoice('${inv.id}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
        });
    }

    async function editInvoice(id) {
        const inv = invoices.find(i => i.id === id);
        editId = id;
        Object.keys(inv).forEach(k => { if (document.getElementById(k)) document.getElementById(k).value = inv[k]; });
    }

    async function deleteInvoice(id) { if (confirm("تأكيد الحذف؟")) { await db.collection("invoices").doc(id).delete(); fetchInvoices(); } }

    function searchInvoice() {
        const term = search.value.toLowerCase().trim();
        const filtered = invoices.filter(inv => inv.invoiceNo.toLowerCase().includes(term) || inv.name.toLowerCase().includes(term) || inv.region.toLowerCase().includes(term) || (inv.note && inv.note.toLowerCase().includes(term)));
        const tbody = document.querySelector("#invoiceTable tbody");
        tbody.innerHTML = "";
        filtered.forEach(inv => {
            tbody.innerHTML += `
                <tr>
                    <td>${inv.invoiceNo}</td><td>${inv.date}</td><td>${inv.name}</td><td>${inv.region}</td>
                    <td>${inv.count}</td><td>${inv.weight}</td><td>${inv.type}</td><td>${inv.price}</td>
                    <td>${inv.total}</td><td>${inv.paid}</td><td>${inv.remaining}</td><td>${inv.note}</td>
                    <td class="action-buttons">
                        <button class="edit-btn" onclick="editInvoice('${inv.id}')"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn" onclick="deleteInvoice('${inv.id}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>`;
        });
    }

    function exportToExcel() {
        let csv = "رقم الفاتورة,التاريخ,الاسم,المنطقة,العدد,الوزن,النوع,السعر,الإجمالي,المدفوع,المتبقي,ملاحظات\n";
        invoices.forEach(inv => { csv += `${inv.invoiceNo},${inv.date},${inv.name},${inv.region},${inv.count},${inv.weight},${inv.type},${inv.price},${inv.total},${inv.paid},${inv.remaining},${inv.note}\n`; });
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "فواتير.csv"; link.click();
    }

    // التحقق من حالة تسجيل الدخول تلقائياً
    auth.onAuthStateChanged(user => {
        if (user) { loginSection.classList.add("hidden"); appContent.classList.remove("hidden"); fetchInvoices(); }
        else { loginSection.classList.remove("hidden"); appContent.classList.add("hidden"); }
    });
</script>
</body>
</html>